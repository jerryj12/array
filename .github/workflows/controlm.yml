name: ControlM

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up environment
        run: |
          echo "endpoint=$(echo ${{ secrets.ITAR_CNTRL_M_API_ENDPNT }})" >> $GITHUB_ENV
          echo "user=$(echo ${{ secrets.CTRLM_USER_ID }})" >> $GITHUB_ENV
          echo "passwd=$(echo ${{ secrets.CTRLM_PASSWD }})" >> $GITHUB_ENV
          echo "ctm=$(echo HANICMAP1)" >> $GITHUB_ENV
          echo "folderName=$(echo PLM-PLMTST-DEPLOYMENT)" >> $GITHUB_ENV
          echo "orderDate=$(echo $(date '+%Y%m%d'))" >> $GITHUB_ENV
          echo "jobName=$(echo Enovia_Deployment)" >> $GITHUB_ENV

      - name: Login
        id: login
        run: |
          response=$(curl --request POST \
            --header 'content-type: application/json' \
            --url $endpoint/run/order \
            --data '{
              "username": "$user",
              "password": "$passwd"
            }')
          echo "token=$(echo $response | tr -d '\r\n\t)" >> $GITHUB_ENV

      - name: Order job
        run: |
          order=$(curl --request POST \
            --header 'authorization: Bearer $token' \
            --header 'content-type: application/json' \
            --url $endpoint/run/order \
            --data '{
              "ctm": "$ctm",
              "folder": "$folderName",
             "jobs": "$jobName",
             "hold": "false",
             "ignoreCriteria": "true",
             "independentFlow": "false",
             "orderDate": "$orderDate",
             "waitForOrderDate": "false",
             "createDuplicate":  "false",
             "orderIntoFolder":  "Recent",
             "variables": {"arg":"12345"}
            }')
            echo $order
      - name: Logout
        run: |
          curl -g -k -H "Authorization: Bearer $TOKEN" -X POST "$endpoint/session/logout" 
      #- name: Login
       # run: |
        #  login=curl -H "Content-Type: application/json" -X POST -d "{"username":"Ahmed","password":"password"}" "https://api.sketchfab.com/session/login"
          #token=$(echo $login | tr -d '\r\n\t ')
         # write-host "$login"
        #env:
         # TOKEN: $token

      #- name: Order Job
       # run: |
        #  curl -X POST -H "Authorization: Bearer $TOKEN" --header "Content-Type: application/json" --header "Accept: application/json" -d "{
         #   \"ctm\": \"$CTM\",
          #  \"folder\": \"$FOLDERNAME\",
           # \"jobs\": \"$JOBNAME\",
            #\"hold\": \"false\",
            #\"ignoreCriteria\": \"true\",
            #\"independentFlow\": \"false\",
            #\"orderDate\": \"$ORDERDATE\",
            #\"waitForOrderDate\": \"false\",
            #\"createDuplicate\": \"false\",
            #\"orderIntoFolder\": \"Recent\",
            #\"variables\": [{\"arg\":\"12345\"}]
          #}" "$ENDPOINT/run/order"

      #- name: Logout
        #run: |
          #curl -g -k -H "Authorization: Bearer $TOKEN" -X POST "$ENDPOINT/session/logout"


      
