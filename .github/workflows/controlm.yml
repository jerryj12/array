name: ControlM

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up environment
        run: |
          endpoint=${{ secrets.ITAR_CNTRL_M_API_ENDPNT }}
          user=${{ secrets.CTRLM_USER_ID }}
          passwd=${{ secrets.CTRLM_PASSWD }}
          ctm=HANICMAP1
          folderName=PLM-PLMTST-DEPLOYMENT
          orderDate=$(date '+%Y%m%d')
          jobName=Enovia_Deployment
        env:
          ENDPOINT: $endpoint
          USER: $user
          PASSWD: $passwd
          CTM: $ctm
          FOLDERNAME: $folderName
          ORDERDATE: $orderDate
          JOBNAME: $jobName

      - name: Login
        run: |
          login=$(curl -H "Content-Type: application/json" -X POST -d "{"username":"Ahmed","password":"password"}" "https://api.sketchfab.com/session/login")
          token=$(echo $login | tr -d '\r\n\t ')
        env:
          TOKEN: $token

      - name: Order Job
        run: |
          curl -X POST -H "Authorization: Bearer $TOKEN" --header "Content-Type: application/json" --header "Accept: application/json" -d "{
            \"ctm\": \"$CTM\",
            \"folder\": \"$FOLDERNAME\",
            \"jobs\": \"$JOBNAME\",
            \"hold\": \"false\",
            \"ignoreCriteria\": \"true\",
            \"independentFlow\": \"false\",
            \"orderDate\": \"$ORDERDATE\",
            \"waitForOrderDate\": \"false\",
            \"createDuplicate\": \"false\",
            \"orderIntoFolder\": \"Recent\",
            \"variables\": [{\"arg\":\"12345\"}]
          }" "$ENDPOINT/run/order"

      - name: Logout
        run: |
          curl -g -k -H "Authorization: Bearer $TOKEN" -X POST "$ENDPOINT/session/logout"


      - name: Squash And Merge After Approval of PR
        run: |
          curl --request POST \
          --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
          --header 'content-type: application/json' \
          --url https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.inputs.pr_num }}/merge \
          --data '{
           "merge_method": "squash",
           "commit_title": "Squash and Merge for Pull Request ${{ github.event.inputs.pr_num }}",
           "commit_message": "expected sha value = ${{ github.event.inputs.pr_head_sha }}",
           "sha":"${{ github.event.inputs.pr_head_sha }}"
           }'
